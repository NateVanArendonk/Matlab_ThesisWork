dname='y:\Projects\pscosmos\runs\salinity_sensitivity\psfm_s5\';
fname    = 'salish_sea_net.nc';
grd         = dflowfm.readNet([dname,fname]);

xg = grd.node.x(grd.edge.NetLink);
yg = grd.node.y(grd.edge.NetLink);
xg(3,:)=NaN;
yg(3,:)=NaN;

dnameh=[dname,'DFM_OUTPUT_ps_2d\'];
fnameh='ps_2d_his.nc';
stns=cellstr(ncread([dnameh,fnameh],'station_name')');
dstns={'NOAA_9443090_Neah_Bay';...
    'NOAA_9444090_Port_Angeles';...
    'NOAA_9444900_Port_Townsend';...
    'NOAA_9447130_Seattle';...
    'NOAA_9446484_Tacoma';...
    'NOAA_9449424_Cherry_Point'};
[~,~,istns]=intersect(dstns,stns,'stable');
gstns=stns(istns);
lons=cellfun(@(x)(ncread([dnameh,fnameh],'station_x_coordinate',...
    [x 1],[1 1])'),num2cell(istns));
lats=cellfun(@(x)(ncread([dnameh,fnameh],'station_y_coordinate',...
    [x 1],[1 1])'),num2cell(istns));

ldb=landboundary('read',['y:\Projects\pscosmos\runs\psfm_m1\',...
    'salish_sea_shoreline.ldb']);

bname='y:\Projects\pscosmos\data\bathy\andrew\nc\gebco\';
bfile='GEBCO_2014_2D_-130.0_46.8_-122.0_51.8.nc';
lat=ncread([bname,bfile],'lat');
lon=ncread([bname,bfile],'lon');
z=ncread([bname,bfile],'elevation');
xd=vdist(lat(1),lon(1),lat(1),lon(end));
yd=vdist(lat(1),lon(1),lat(end),lon(end));
xi=linspace(0,xd,numel(lon));
yi=linspace(0,yd,numel(lat));
hs=real2rgb(hillshade(z',xi,yi,'zfactor',2),'gray',[0 255]);

rlocs=[-122.869086  47.737296;...
    -122.587885  47.187664;...
    -122.909572  47.058475;...
    -122.652783  47.727286;...
    -122.924730  47.639832;...
    -123.126193  48.161717;...
    -122.363769  47.589485;...
    -123.574258  48.151710;...
    -123.077917  47.211642;...
    -124.363044  48.290389;...
    -122.687614  47.356550;...
    -124.677124  48.307490;...
    -122.297421  48.058815;...
    -122.700719  47.114956;...
    -122.582937  48.746604;...
    -122.445704  47.276299;...
    -122.493481  48.594663;...
    -122.484067  48.303545;...
    -123.130697  47.366370;...
    -122.294967  48.015249;...
    -122.426621  48.163621;...
    -122.297221  48.059632];
blocs=[-123.165 48.334;...
    -124.726  48.493];
    
mdata=load('y:\Projects\pscosmos\data\meteo\Met_stations.mat');

fun=@(x)([min(x) max(x)]);
lonlim=[-129.22892620896	-122];
latlim=[46.9675525931304	51.6220608123692];


[lonm,latm]=meshgrid(lon,lat);

latlim2=[47 48.9];
lonlim2=[-125 -122.05];

addpath('C:\Program Files\MATLAB\R2017b\toolbox\map\mapproj\')
f=figure;
set(f,'renderer','zbuffer','units','inches',...
    'position',[0 0 9 7],...
    'paperpositionmode','au')

axesm('mercator')
hold on 
[x,y]=mfwdtran(latm,lonm);
[xp,yp]=mfwdtran(grd.node.y,grd.node.x);
[xl,yl]=mfwdtran(latlim,lonlim);

sh=surf(x,y,zeros(size(x)),hs);
set(sh,'edgecolor','none')



hold on

lh=plotm(yg(:),xg(:),'-')
plotm(ldb(:,2),ldb(:,1),'k-')

[leg,legh]=legend(sh,'Model domain');
set(leg,'location','northeast','fontang','it',...
    'fontweight','b','autoupdate','off');
set(legh(2),'edgecolor','none',...
    'facecolor',get(lh,'color'))


linem(latlim2,[lonlim2(1) lonlim2(1)],'-','color','k')
linem(latlim2,[lonlim2(2) lonlim2(2)],'-','color','k')
linem([latlim2(1) latlim2(1)],lonlim2,'-','color','k')
linem([latlim2(2) latlim2(2)],lonlim2,'-','color','k')

xp=lonlim2(1)+0.05*diff(lonlim2);
yp=latlim2(1)+0.95*diff(latlim2);
textm(yp,xp,'\bf\itDetail area',...
    'backgroundcolor','w','margin',1)

setm(gca,'maplonlimit',lonlim,...
    'maplatlimit',latlim,...
    'mlabelloc',2,...
    'mlineloc',2,...
    'plabelloc',2,...
    'plineloc',2,...
    'mlabelparallel','north',...
    'plabelmeridian','west',...
    'parallellab','on',...
    'meridianlab','on',...
    'mlabelround',0,...
    'plabelround',0,...
    'grid','on',...
    'flinewidth',1,...
    'frame','on',...
    'labelformat','none');
colormap(jet)
set(gca,'visible','off',...
    'xlim',xl,...
    'ylim',yl)
lx=lonlim(1)+0.02*diff(lonlim);
ly=latlim(1)+0.05*diff(latlim);

[xr,yr]=projfwd(getm(gca),ly,lx);
rh = scaleruler;
setm(rh,'units','km',...
    'majortick',(0:50:150),...
    'majorticklength',5,...
    'minortick',[0 0],...
    'minorticklength',0,...
    'xloc',xr,...
    'yloc',yr,...
    'color','k',...
    'linewi',2,...
    'fontang','it',...
    'fontweight','b')
%%%%%-----------------------------------------------------

serverURL = ['http://ows.terrestris.de/osm/service?SERVICE',...
    '=WMS&VERSION=1.1.1&REQUEST=GetCapabilities'];
info = wmsinfo(serverURL);



imageLength=1024*2;

orthoLayer = info.Layer(2);
 [A, R] = wmsread(orthoLayer, 'Latlim', latlim2,...
            'Lonlim', lonlim2, ...
            'ImageHeight', imageLength,...
            'ImageWidth', imageLength');

f=figure;
set(f,'renderer','zbuffer','units','inches',...
    'position',[0 0 9 7],...
    'paperpositionmode','au')

axesm('mercator')
hold on 
geoshow(A,R)
[xl,yl]=mfwdtran(latlim2,lonlim2);

sh=patchm([0.1 0.1 0 0 0.1],[0 0.1 0.1 0 0],'k');

hold on

gh=plotm(yg(:),xg(:),'-');
plotm(ldb(:,2),ldb(:,1),'k-')

mh=plotm(mdata.lat,mdata.lon,'k>','markerfacecolor',...
    [0.9290    0.6940    0.1250],'markersize',6);

wh=plotm(lats,lons,'rd','markerfacecolor','r');
th=textm(lats,lons,{'NB';'PA';'PT';'SEA';'TAC';'CP'});
set(th,'color','r','verticalalign','top')

dh=plotm(rlocs(:,2),rlocs(:,1),'ks','markerfacecolor','y');
bh=plotm(blocs(:,2),blocs(:,1),'kp','markerfacecolor',...
    [0.8500    0.3250    0.0980],'markersize',10);


[leg,legh]=legend([sh;wh;dh;bh;mh],'Model domain','NOAA water levels',...
    'USGS fluvial inputs','NOAA wave buoys','NCDC met. stations');
set(leg,'location','northwest','fontang','it',...
    'fontweight','b','autoupdate','off');
set(legh(6),'edgecolor','none',...
    'facecolor',get(gh,'color'))

setm(gca,'maplonlimit',lonlim2,...
    'maplatlimit',latlim2,...
    'mlabelloc',1,...
    'mlineloc',1,...
    'plabelloc',1,...
    'plineloc',1,...
    'mlabelparallel','north',...
    'plabelmeridian','west',...
    'parallellab','on',...
    'meridianlab','on',...
    'mlabelround',0,...
    'plabelround',0,...
    'grid','on',...
    'flinewidth',1,...
    'frame','on',...
    'labelformat','none');

set(gca,'visible','off',...
    'xlim',xl,...
    'ylim',yl)
lx=lonlim2(1)+0.02*diff(lonlim2);
ly=latlim2(1)+0.01*diff(latlim2);

[xr,yr]=projfwd(getm(gca),ly,lx);
rh = scaleruler;
setm(rh,'units','km',...
    'majortick',(0:25:50),...
    'majorticklength',5,...
    'minortick',[0 0],...
    'minorticklength',0,...
    'xloc',xr,...
    'yloc',yr,...
    'color','k',...
    'linewi',2,...
    'fontang','it',...
    'fontweight','b')

%%%--------------------------------------------------------------
latlim3=[48.0055182383695 48.2577688255961 ];
lonlim3=[-122.927009914402 -122.528351294616];


serverURL = ['https://basemap.nationalmap.gov/arcgis/services/',...
    'USGSImageryOnly/MapServer/WMSServer?request=GetCapabilities&service=WMS'];
info = wmsinfo(serverURL);



imageLength=1024*2;

orthoLayer = info.Layer(1);
 [A, R] = wmsread(orthoLayer, 'Latlim', latlim3,...
            'Lonlim', lonlim3, ...
            'ImageHeight', imageLength,...
            'ImageWidth', imageLength');

f=figure;
set(f,'renderer','zbuffer','units','inches',...
    'position',[0 0 5 4],...
    'paperpositionmode','au')

axesm('mercator')
hold on 
geoshow(A,R)
[xl,yl]=mfwdtran(latlim3,lonlim3);

sh=patchm([0.1 0.1 0 0 0.1],[0 0.1 0.1 0 0],'k');

hold on

cols=get(gca,'colororder');
gh=plotm(yg(:),xg(:),'-','color',cols(6,:));
plotm(ldb(:,2),ldb(:,1),'k-')

setm(gca,'maplonlimit',lonlim3,...
    'maplatlimit',latlim3,...
    'mlabelloc',0.1,...
    'mlineloc',0.1,...
    'plabelloc',0.1,...
    'plineloc',0.1,...
    'mlabelparallel','north',...
    'plabelmeridian','west',...
    'parallellab','on',...
    'meridianlab','on',...
    'mlabelround',-1,...
    'plabelround',-1,...
    'grid','on',...
    'flinewidth',1,...
    'frame','on',...
    'labelformat','none');

set(gca,'visible','off',...
    'xlim',xl,...
    'ylim',yl)
lx=lonlim3(1)+0.02*diff(lonlim3);
ly=latlim3(1)+0.01*diff(latlim3);

[xr,yr]=projfwd(getm(gca),ly,lx);
rh = scaleruler;
setm(rh,'units','km',...
    'majortick',(0:5:10),...
    'majorticklength',0.5,...
    'minortick',[0 0],...
    'minorticklength',0,...
    'xloc',xr,...
    'yloc',yr,...
    'color','w',...
    'linewi',2,...
    'fontang','it',...
    'fontweight','b')