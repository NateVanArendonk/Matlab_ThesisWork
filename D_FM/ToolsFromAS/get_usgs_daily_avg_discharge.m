% column 1 - USGS Gauge ID
% column 2 - discharge (need to combine some gauges)
% column 3 - name for discharge point
sites={'12080010',1,'deschutes';...
    '12076800',2,'goldsborough';...
    '12073500',3,'huge';...
    '12090500',4,'clover';...
    '12091100',4,'flett';...
    '12101500',5,'puyallup';...
    '12102190',5,'swan';...
    '12102190',5,'clarks';...
    '12089500',6,'nisqually';...
    '12089208',6,'centralia_canal';...
    '12113344',7,'duwamish';...
    '12119000',8,'cedar';...
    '12150800',9,'snohomish';...
    '12157250',10,'mission';...
    '12158040',11,'tuyalip';...
    '12167000',12,'stilliguamish';...
    '12200500',13,'skagit';...
    '12201500',14,'samish';...
    '12213100',15,'nooksack';...
    '12043163',16,'miller';...
    '12043300',17,'hoko';...
    '12045500',18,'elwha';...
    '12048000',19,'dungeness';...
    '12070000',20,'dogfish';...
    '12052210',21,'big_quilcene';...
    '12054000',22,'duckabush';...
    '12058790',23,'skokomish';...
    '12061500',24,'skokomish'}

cmat=cell(length(sites),1);
for i=1:length(sites)
    url=['https://waterservices.usgs.gov/nwis/stat/?format=rdb',...
        '&sites=',sites{i,1},...
        '&statReportType=daily&statTypeCd=median&parameterCd=00060'];
    rdata=webread(url);
    data=textscan(rdata,'%[^\n]','commentstyle','#');
    fmt='%*s%*f%*s%*f%f%f%*f%*f%f%f';
    cdata=cellfun(@(x)(textscan(x,fmt)),...
        cellstr(data{1}(3:end)),'un',0);
    cmat{i}=cell2mat(cat(1,cdata{:}));
end
baseyr=2017;
dates=cellfun(@(x)(datenum(...
    repmat(baseyr,size(x,1),1),x(:,1),x(:,2))),...
    cmat,'un',0);
doy=date2doy(dates{1})-1;
cms=cellfun(@(x)(x(:,4).*0.0283168),cmat,'un',0);

snames=cellfun(@(x)(sprintf('%s,',x)),sites(:,1),'un',0);
snames=cat(2,snames{:});

sidx=cell2mat(sites(:,2));
udis=unique(sidx);
dis=repmat(struct('station',[],...
    'time',[],...
    'cms',[]),length(udis),1);
refdate=datenum(2017,1,1);
days=refdate+doy;
mins=(days-refdate).*1440;
[dis(:).time]=deal(mins);
for i=1:length(udis)
    cidx=find(sidx==udis(i));
    dis(i).station=sites(cidx(1),3);
    if numel(cidx)==1
        dis(i).cms=cms{cidx};
    else
        dis(i).cms=sum(cell2mat(cms(cidx)'),2);
        
    end
end

out='y:\Projects\pscosmos\data\discharge\with_temperature\';
arrayfun(@(x)(dlmwrite([out,x.station{:},'.tim'],...
    [x.time,x.cms,zeros(numel(x.cms),1) ones(numel(x.cms),1).*13],...
    'delimiter',' ','precision','%0.2f')),dis)

%picked off spots for discharge locations on google earth
locs=[-122.869086  47.737296;...
    -122.220769  47.508005;...
    -122.587885  47.187664;...
    -122.909572  47.058475;...
    -122.652783  47.727286;...
    -122.924730  47.639832;...
    -123.126193  48.161717;...
    -122.363769  47.589485;...
    -123.574258  48.151710;...
    -123.077917  47.211642;...
    -124.363044  48.290389;...
    -122.687614  47.356550;...
    -124.677124  48.307490;...
    -122.297421  48.058815;...
    -122.700719  47.114956;...
    -122.582937  48.746604;...
    -122.445704  47.276299;...
    -122.493481  48.594663;...
    -122.484067  48.303545;...
    -123.130697  47.366370;...
    -122.294967  48.015249;...
    -122.426621  48.163621;...
    -122.297221  48.059632];
slocs=sort(arrayfun(@(x)(x.station{:}),dis,'un',0));
fout=[out,'discharge_locs.xyn'];
fid=fopen(fout,'wt');
for i=1:length(locs)
    fprintf(fid,'%.6f\t%0.6f\t"%s"\n',...
        locs(i,1),locs(i,2),slocs{i});
end
fclose(fid);
 
dmax=arrayfun(@(x)(max(x.cms)),dis);
[dsort,didx]=sort(dmax,'descend');
figure
hold on 
arrayfun(@(x)(plot(doy,x.cms)),dis(didx))
xlabel('Day of year')
ylabel('Q (m^3/s)')
box on
set(gca,'yscale','log')

cmapline
legend(arrayfun(@(x)(x.station{:}),dis(didx),'un',0),...
    'interpreter','none',...
    'location','eastoutside')

